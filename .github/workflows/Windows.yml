name: Windows Build and Test
on:
  push:
    branches: [ develop , main , windows/* ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'
        cache: 'pip'

    - name: Windows Build
      shell: cmd  
      run: .\build\build.bat

    - name: Verify Build
      shell: cmd
      run: |
        dir /b /s SNES-IDE-out || echo "SNES-IDE-out not found"

    - name: Compress SNES-IDE-out
      shell: pwsh
      run: |
        if (Test-Path -Path 'SNES-IDE-out') {
          Remove-Item -Path 'SNES-IDE-out.zip' -ErrorAction SilentlyContinue
          Compress-Archive -Path 'SNES-IDE-out/*' -DestinationPath 'SNES-IDE-out.zip' -Force
          Write-Host "Created SNES-IDE-out.zip"
        } else {
          Write-Error "SNES-IDE-out directory missing"
        }

    - name: Upload build artifact
      uses: actions/upload-artifact@v4
      with:
        name: sneside-out
        path: SNES-IDE-out.zip
        retention-days: 7

  test:
    runs-on: windows-latest
    needs: build

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'
        cache: 'pip'

    - name: Download build artifact
      uses: actions/download-artifact@v4
      with:
        name: sneside-out
        path: .

    - name: Extract build artifact
      shell: pwsh
      run: |
        $zip = Get-ChildItem -Path . -Filter '*.zip' -Recurse | Select-Object -First 1
        if ($null -eq $zip) { Write-Error "No zip artifact found"; exit 1 }
        Write-Host "Extracting $($zip.FullName)"
        Expand-Archive -LiteralPath $zip.FullName -DestinationPath './SNES-IDE-out' -Force

#    - name: Run test script (runs INSTALL.bat if present)
#      shell: pwsh
#      run: |
#        python -u tests/test.py > tests.log 2>&1 || $LASTEXITCODE = $LASTEXITCODE
#        Write-Host "Test run finished with exit code $LASTEXITCODE"
#        if ($LASTEXITCODE -ne 0) { Write-Host 'Tests failed' ; exit $LASTEXITCODE }

#    - name: Upload test logs (on failure or success)
#      if: always()
#      uses: actions/upload-artifact@v4
#      with:
#        name: test-logs
#        path: tests.log
#        retention-days: 7

